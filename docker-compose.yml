services:
  api-virtual:
    build:
      context: .
      dockerfile: api-virtual/Dockerfile.dev
    container_name: api-virtual
    ports:
      - "4000:4000"
      - "9231:9229"
    volumes:
      - ./api-virtual:/app/api-virtual
      - /app/api-virtual/node_modules
    command: npm run debug
    environment:
      - PORT=4000
      - SWAGGER_ENABLED=true
      - TIMING_ENABLED=true
      - TIMING_LOG=true
      - TIMING_HEADER=x-virtual-response-time-ms
      - HOT_RELOAD_ENABLED=true
      - HOT_RELOAD_INTERVAL_MS=2000

  postgres:
    image: postgres:15-alpine
    container_name: postgres-virtual
    networks:
      - virtualization-shared
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=affiliations
    volumes:
      - postgres_virtual_data:/var/lib/postgresql/data

  opensearch:
    image: opensearchproject/opensearch:2.12.0
    container_name: opensearch-virtual
    ports:
      - "9200:9200"
      - "9600:9600"
    environment:
      - discovery.type=single-node
      - plugins.security.disabled=true
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=Admin123!StrongPass
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
    ulimits:
      memlock:
        soft: -1
        hard: -1

  redis:
    image: redis:7-alpine
    container_name: redis-virtual
    ports:
      - "6379:6379"
    volumes:
      - redis_virtual_data:/data

  mongo:
    image: mongo:7
    container_name: mongo-virtual
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=mongo
      - MONGO_INITDB_ROOT_PASSWORD=mongo
      - MONGO_INITDB_DATABASE=virtual
    volumes:
      - mongo_virtual_data:/data/db

  nginx:
    image: nginx:alpine
    container_name: nginx-virtualization
    ports:
      - "8081:80"
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      api-virtual:
        condition: service_started

volumes:
  postgres_virtual_data:
  redis_virtual_data:
  mongo_virtual_data:

networks:
  virtualization-shared:
    name: virtualization-shared
